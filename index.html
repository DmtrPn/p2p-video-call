<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .wizard-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .step-card.active {
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .step-card.completed {
            opacity: 0.7;
            background: rgba(78, 205, 196, 0.2);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 15px;
        }

        .step-card.completed .step-number {
            background: #4ecdc4;
        }

        .step-card.completed .step-number::after {
            content: '‚úì';
            color: white;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .step-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .choice-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            position: relative;
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .choice-btn.create {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .choice-btn.join {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .choice-btn .emoji {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 16px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-group input:focus, .input-group textarea:focus {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .room-id-display {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .room-id-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 180px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #44a08d, #4ecdc4);
        }

        .button:active { transform: translateY(-1px); }

        .button.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .button.primary:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
        }

        .code-display {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(78, 205, 196, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .code-content {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .copy-success {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #4ecdc4;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copy-success.show {
            opacity: 1;
        }

        .instruction-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .instruction-box .icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-container {
            display: none;
            width: 100%;
            position: relative;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-grid.fullscreen {
            grid-template-columns: 1fr;
        }

        .video-grid.fullscreen .local-video-wrapper {
            display: none;
        }

        .video-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .local-video-wrapper video {
            transform: scaleX(-1);
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            position: relative;
        }

        .control-btn.mic { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .control-btn.camera { background: linear-gradient(45deg, #667eea, #764ba2); }
        .control-btn.hangup { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
        .control-btn.fullscreen { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .control-btn.share { background: linear-gradient(45deg, #f39c12, #d35400); }
        .control-btn:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .control-btn.off { opacity: 0.5; background: #666; }

        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .video-grid { grid-template-columns: 1fr; }
            .choice-buttons { flex-direction: column; }
            .choice-btn { min-width: unset; }
            .controls { gap: 10px; }
            .control-btn { width: 50px; height: 50px; font-size: 20px; }
            .wizard-container { max-width: 100%; }
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üé• P2P –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</h1>
        <p>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã WebRTC</p>
    </div>

    <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div id="step1" class="wizard-container">
        <div class="step-card active">
            <div class="step-number">1</div>
            <div class="step-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å</div>
            <div class="step-description">
                –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É?
            </div>
            <div class="choice-buttons">
                <button class="choice-btn create" id="create-btn">
                    <span class="emoji">üìû</span>
                    –°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="choice-btn join" id="join-btn">
                    <span class="emoji">üì≤</span>
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>

    <!-- –®–∞–≥ 2a: –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ -->
    <div id="step2-create" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-create">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">–°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">–í–∞—à ID –∫–æ–º–Ω–∞—Ç—ã</div>
            <div class="step-description">
                –≠—Ç–æ—Ç ID –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </div>

            <div class="room-id-display">
                <div>ID –∫–æ–º–Ω–∞—Ç—ã:</div>
                <div class="room-id-value" id="room-id-display"></div>
            </div>

            <button class="button" id="generate-btn">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="button primary" id="create-call-btn">–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
    </div>

    <!-- –®–∞–≥ 2b: –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É -->
    <div id="step2-join" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-join">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã</div>
            <div class="step-description">
                –í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –ø—Ä–∏—Å–ª–∞–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫
            </div>

            <div class="input-group">
                <label for="join-room-id">ID –∫–æ–º–Ω–∞—Ç—ã –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
                <input type="text" id="join-room-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ABC12345"
                       style="text-align: center; font-size: 20px; letter-spacing: 2px;">
            </div>

            <button class="button primary" id="join-call-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –®–∞–≥ 3: –û–±–º–µ–Ω –∫–æ–¥–∞–º–∏ -->
    <div id="step3" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-step3">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="step-card active">
            <div class="step-number">3</div>
            <div class="step-title" id="exchange-title">–û–±–º–µ–Ω –∫–æ–¥–∞–º–∏</div>
            <div class="step-description" id="exchange-description">
                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...
            </div>

            <!-- –ü–æ–∫–∞–∑ —Å–≤–æ–µ–≥–æ –∫–æ–¥–∞ -->
            <div id="my-code-section" class="hidden">
                <div class="instruction-box">
                    <span class="icon">üìã</span>
                    <strong id="code-instruction">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</strong>
                </div>

                <div class="code-display">
                    <div class="copy-success" id="copy-success">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! ‚úì</div>
                    <div class="code-content" id="my-code"></div>
                    <button class="button" id="copy-btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                </div>
            </div>

            <!-- –í–≤–æ–¥ —á—É–∂–æ–≥–æ –∫–æ–¥–∞ -->
            <div id="remote-code-section" class="hidden">
                <div class="instruction-box">
                    <span class="icon">üì•</span>
                    <strong id="remote-instruction">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</strong>
                </div>

                <div class="input-group">
                    <label for="remote-code-input">–ö–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
                    <textarea id="remote-code-input" rows="4"
                              placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫"></textarea>
                </div>

                <button class="button primary" id="connect-btn">üîó –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            </div>

            <div id="status" class="status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ -->
    <div id="video-container" class="video-container">
        <div class="video-grid" id="video-grid">
            <div class="video-wrapper local-video-wrapper">
                <video id="local-video" autoplay muted playsinline></video>
                <div class="video-label">–í—ã</div>
            </div>
            <div class="video-wrapper">
                <video id="remote-video" autoplay playsinline></video>
                <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn mic" id="mic-btn" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button class="control-btn camera" id="camera-btn" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
            <button class="control-btn share" id="share-btn" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º">üñ•Ô∏è</button>
            <button class="control-btn fullscreen" id="fullscreen-btn" title="–°–∫—Ä—ã—Ç—å –º–æ–µ –≤–∏–¥–µ–æ">üëÅÔ∏è</button>
            <button class="control-btn hangup" id="hangup-btn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
        </div>
    </div>
</div>

<script>
    let localStream;
    let cameraStream;
    let remoteStream;
    let peerConnection;
    let isInitiator = false;
    let roomId = '';
    let micEnabled = true;
    let cameraEnabled = true;
    let isFullscreen = false;
    let isScreenSharing = false;
    let currentStep = 1;
    let userRole = ''; // 'create' –∏–ª–∏ 'join'

    const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ];

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
    function encodeData(data) {
        try {
            const jsonStr = JSON.stringify(data);
            return btoa(unescape(encodeURIComponent(jsonStr)));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            return null;
        }
    }

    function decodeData(encoded) {
        try {
            const jsonStr = decodeURIComponent(escape(atob(encoded)));
            return JSON.parse(jsonStr);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            return null;
        }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∞–≥–∞–º
    function showStep(stepId) {
        document.querySelectorAll('.wizard-container, .video-container').forEach(el => {
            el.classList.add('hidden');
        });
        document.getElementById(stepId).classList.remove('hidden');
    }

    function chooseRole(role) {
        userRole = role;
        generateRoomId();

        if (role === 'create') {
            document.getElementById('room-id-display').textContent = roomId;
            showStep('step2-create');
        } else {
            showStep('step2-join');
        }
        currentStep = 2;
    }

    function goBack() {
        if (currentStep === 2) {
            showStep('step1');
            currentStep = 1;
        } else if (currentStep === 3) {
            if (userRole === 'create') {
                showStep('step2-create');
            } else {
                showStep('step2-join');
            }
            currentStep = 2;
            // –û—á–∏—Å—Ç–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            cleanup();
        }
    }

    function generateRoomId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        roomId = result;
        return result;
    }

    function generateNewRoomId() {
        generateRoomId();
        document.getElementById('room-id-display').textContent = roomId;
    }

    async function startCreatingCall() {
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('exchange-title').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞';
        document.getElementById('exchange-description').textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('exchange-description').textContent = '–°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';

        await createOffer();

        updateProgress(75);
        document.getElementById('exchange-description').textContent = '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.';
        document.getElementById('code-instruction').textContent = 'üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –≤ –ª—é–±–æ–º –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ:';
        document.getElementById('my-code-section').classList.remove('hidden');
        document.getElementById('remote-code-section').classList.remove('hidden');
        document.getElementById('remote-instruction').textContent = 'üì• –ö–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–∏—à–ª–µ—Ç —Å–≤–æ–π –∫–æ–¥, –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Å—é–¥–∞:';
    }

    async function startJoiningCall() {
        const enteredRoomId = document.getElementById('join-room-id').value.trim();
        if (!enteredRoomId) {
            alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            return;
        }

        roomId = enteredRoomId;
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('exchange-title').textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É';
        document.getElementById('exchange-description').textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('exchange-description').textContent = '–ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.';
        document.getElementById('remote-code-section').classList.remove('hidden');
        document.getElementById('remote-instruction').textContent = 'üì• –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';

        createPeerConnection();
        isInitiator = false;
    }

    function updateProgress(percent) {
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    async function initializeMedia() {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30, max: 30 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };

            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraStream.getVideoTracks().forEach(t => { try { t.contentHint = 'motion'; } catch {} });
            cameraStream.getAudioTracks().forEach(t => { try { t.contentHint = 'speech'; } catch {} });

            localStream = cameraStream;
            document.getElementById('local-video').srcObject = localStream;
            updateStatus('–ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚úì');
            return true;
        } catch (error) {
            updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
            return false;
        }
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection({ iceServers });

        if (localStream) {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remote-video');
            if (event.streams && event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
                updateStatus('–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ‚úì');
            }
        };

        peerConnection.onicecandidate = () => {};

        peerConnection.oniceconnectionstatechange = () => {
            const s = peerConnection.iceConnectionState;
            if (s === 'checking') updateStatus('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
            if (s === 'connected') updateStatus('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            if (s === 'disconnected') updateStatus('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Ç–µ—Ä—è–Ω–æ...');
            if (s === 'failed') updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            if (s === 'closed') updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
        };

        peerConnection.onconnectionstatechange = () => {
            const state = peerConnection.connectionState;
            if (state === 'connected') {
                showVideoInterface();
                updateStatus('üéâ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
            }
        };
    }

    function waitForIceGathering(pc, timeoutMs = 3000) {
        return new Promise((resolve) => {
            const done = () => resolve();
            if (!pc || pc.iceGatheringState === 'complete') return done();

            const onChange = () => {
                if (pc.iceGatheringState === 'complete') {
                    pc.removeEventListener('icegatheringstatechange', onChange);
                    done();
                }
            };
            pc.addEventListener('icegatheringstatechange', onChange);

            setTimeout(() => {
                pc.removeEventListener('icegatheringstatechange', onChange);
                done();
            }, timeoutMs);
        });
    }

    async function createOffer() {
        createPeerConnection();
        isInitiator = true;

        try {
            const offer = await peerConnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            });
            await peerConnection.setLocalDescription(offer);

            updateStatus('‚è≥ –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            await waitForIceGathering(peerConnection, 3000);

            const encoded = encodeData(peerConnection.localDescription);
            document.getElementById('my-code').textContent = encoded;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message);
        }
    }

    async function processRemoteCode() {
        const remoteCode = document.getElementById('remote-code-input').value.trim();
        if (!remoteCode) {
            alert('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
            return;
        }

        try {
            updateStatus('üîó –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
            const decoded = decodeData(remoteCode);

            if (!decoded) {
                updateStatus('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }

            if (isInitiator) {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                await peerConnection.setRemoteDescription(new RTCSessionDescription(decoded));
                updateStatus('‚úÖ –ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
            } else {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                await peerConnection.setRemoteDescription(new RTCSessionDescription(decoded));

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                updateStatus('‚è≥ –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥...');
                await waitForIceGathering(peerConnection, 3000);

                const encoded = encodeData(peerConnection.localDescription);
                document.getElementById('my-code').textContent = encoded;
                document.getElementById('my-code-section').classList.remove('hidden');
                document.getElementById('code-instruction').textContent = 'üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:';

                updateStatus('‚úÖ –û—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–¥ –≥–æ—Ç–æ–≤! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–¥–∞: ' + error.message);
        }
    }

    function copyMyCode() {
        const code = document.getElementById('my-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const success = document.getElementById('copy-success');
            success.classList.add('show');
            setTimeout(() => success.classList.remove('show'), 2000);
        });
    }

    function showVideoInterface() {
        document.getElementById('video-container').style.display = 'block';
        showStep('video-container');
        updateProgress(100);
    }

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
    }

    function toggleMic() {
        const btn = document.getElementById('mic-btn');
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                micEnabled = !micEnabled;
                audioTrack.enabled = micEnabled;
                btn.classList.toggle('off', !micEnabled);
                btn.innerHTML = micEnabled ? 'üé§' : 'üîá';
            }
        }
    }

    function toggleCamera() {
        const btn = document.getElementById('camera-btn');
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                cameraEnabled = !cameraEnabled;
                videoTrack.enabled = cameraEnabled;
                btn.classList.toggle('off', !cameraEnabled);
                btn.innerHTML = cameraEnabled ? 'üìπ' : 'üì∑';
            }
        }
    }

    async function toggleScreenShare() {
        const btn = document.getElementById('share-btn');

        try {
            if (!isScreenSharing) {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });

                if (peerConnection) {
                    const sender = peerConnection.getSenders().find(s =>
                        s.track && s.track.kind === 'video'
                    );
                    if (sender) {
                        await sender.replaceTrack(screenStream.getVideoTracks()[0]);
                    }
                }

                document.getElementById('local-video').srcObject = screenStream;
                isScreenSharing = true;
                btn.classList.add('active');
                btn.innerHTML = 'üé•';

                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopScreenShare();
                });
            } else {
                stopScreenShare();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
        }
    }

    async function stopScreenShare() {
        const btn = document.getElementById('share-btn');

        if (cameraStream && peerConnection) {
            const sender = peerConnection.getSenders().find(s =>
                s.track && s.track.kind === 'video'
            );
            if (sender) {
                await sender.replaceTrack(cameraStream.getVideoTracks()[0]);
            }
        }

        document.getElementById('local-video').srcObject = cameraStream;
        isScreenSharing = false;
        btn.classList.remove('active');
        btn.innerHTML = 'üñ•Ô∏è';
    }

    function toggleFullscreen() {
        const grid = document.getElementById('video-grid');
        const btn = document.getElementById('fullscreen-btn');

        isFullscreen = !isFullscreen;
        grid.classList.toggle('fullscreen', isFullscreen);
        btn.innerHTML = isFullscreen ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
    }

    function hangUp() {
        cleanup();
        showStep('step1');
        currentStep = 1;
        userRole = '';
        updateStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
    }

    function cleanup() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        document.getElementById('local-video').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        document.getElementById('video-container').style.display = 'none';

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        micEnabled = true;
        cameraEnabled = true;
        isFullscreen = false;
        isScreenSharing = false;

        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('mic-btn').classList.remove('off');
        document.getElementById('mic-btn').innerHTML = 'üé§';
        document.getElementById('camera-btn').classList.remove('off');
        document.getElementById('camera-btn').innerHTML = 'üìπ';
        document.getElementById('share-btn').classList.remove('active');
        document.getElementById('share-btn').innerHTML = 'üñ•Ô∏è';
        document.getElementById('fullscreen-btn').innerHTML = 'üëÅÔ∏è';
        document.getElementById('video-grid').classList.remove('fullscreen');

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        document.getElementById('join-room-id').value = '';
        document.getElementById('remote-code-input').value = '';
        document.getElementById('my-code').textContent = '';

        // –°–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π
        document.getElementById('my-code-section').classList.add('hidden');
        document.getElementById('remote-code-section').classList.add('hidden');

        updateProgress(0);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.getElementById('create-btn').addEventListener('click', () => chooseRole('create'));
        document.getElementById('join-btn').addEventListener('click', () => chooseRole('join'));

        document.getElementById('back-btn-create').addEventListener('click', goBack);
        document.getElementById('back-btn-join').addEventListener('click', goBack);
        document.getElementById('back-btn-step3').addEventListener('click', goBack);

        document.getElementById('generate-btn').addEventListener('click', generateNewRoomId);
        document.getElementById('create-call-btn').addEventListener('click', startCreatingCall);
        document.getElementById('join-call-btn').addEventListener('click', startJoiningCall);

        document.getElementById('copy-btn').addEventListener('click', copyMyCode);
        document.getElementById('connect-btn').addEventListener('click', processRemoteCode);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–º
        document.getElementById('mic-btn').addEventListener('click', toggleMic);
        document.getElementById('camera-btn').addEventListener('click', toggleCamera);
        document.getElementById('share-btn').addEventListener('click', toggleScreenShare);
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        document.getElementById('hangup-btn').addEventListener('click', hangUp);
    });
</script>
</body>
</html>