<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Видеозвонки с Firebase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .wizard-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .step-card.active {
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .step-card.completed {
            opacity: 0.7;
            background: rgba(78, 205, 196, 0.2);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 15px;
        }

        .step-card.completed .step-number {
            background: #4ecdc4;
        }

        .step-card.completed .step-number::after {
            content: '✓';
            color: white;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .step-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .choice-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            position: relative;
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .choice-btn.create {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .choice-btn.join {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .choice-btn .emoji {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 16px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-group input:focus, .input-group textarea:focus {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .room-id-display {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .room-id-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 180px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #44a08d, #4ecdc4);
        }

        .button:active { transform: translateY(-1px); }

        .button.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .button.primary:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-container {
            display: none;
            width: 100%;
            position: relative;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-grid.fullscreen {
            grid-template-columns: 1fr;
        }

        .video-grid.fullscreen .local-video-wrapper {
            display: none;
        }

        .video-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .local-video-wrapper video {
            transform: scaleX(-1);
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            position: relative;
        }

        .control-btn.mic { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .control-btn.camera { background: linear-gradient(45deg, #667eea, #764ba2); }
        .control-btn.hangup { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
        .control-btn.fullscreen { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .control-btn.share { background: linear-gradient(45deg, #f39c12, #d35400); }
        .control-btn:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .control-btn.off { opacity: 0.5; background: #666; }

        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.5s ease;
        }

        .config-section {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .config-section h4 {
            margin-bottom: 10px;
            color: #ffc107;
        }

        .config-section p {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .video-grid { grid-template-columns: 1fr; }
            .choice-buttons { flex-direction: column; }
            .choice-btn { min-width: unset; }
            .controls { gap: 10px; }
            .control-btn { width: 50px; height: 50px; font-size: 20px; }
            .wizard-container { max-width: 100%; }
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden { display: none !important; }
        .waiting { opacity: 0.6; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🎥 P2P Видеозвонки</h1>
        <p>Автоматическая настройка через Firebase</p>
    </div>

    <!-- Конфигурация Firebase -->
    <div id="firebase-config" class="wizard-container">
        <div class="step-card active">
            <div class="step-number">⚙️</div>
            <div class="step-title">Настройка Firebase</div>
            <div class="step-description">
                Введите настройки вашего Firebase проекта
            </div>
            
            <div class="config-section">
                <h4>📋 Настройка приватной Firebase БД:</h4>
                <p><strong>1. Firebase Console:</strong></p>
                <p>• Зайдите в проект → <strong>Realtime Database</strong></p>
                <p>• Создайте базу в <strong>locked mode</strong></p>
                <p>• В разделе <strong>Rules</strong> установите:</p>
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0;">
{<br>
&nbsp;&nbsp;"rules": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;"rooms": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"$roomId": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".read": "auth != null",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".write": "auth != null"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
                </div>
                <p><strong>2. Authentication:</strong></p>
                <p>• Перейдите в <strong>Authentication</strong> → <strong>Sign-in method</strong></p>
                <p>• Включите <strong>Anonymous</strong> провайдер</p>
            </div>

            <div class="input-group">
                <label for="api-key">API Key:</label>
                <input type="text" id="api-key" placeholder="AIzaSyA...">
            </div>

            <div class="input-group">
                <label for="project-id">Project ID:</label>
                <input type="text" id="project-id" placeholder="my-project-12345">
            </div>

            <div class="input-group">
                <label for="database-url">Database URL:</label>
                <input type="text" id="database-url" placeholder="https://my-project-12345-default-rtdb.firebaseio.com/">
            </div>

            <button class="button primary" id="connect-firebase-btn">🔗 Подключиться к Firebase</button>
        </div>
    </div>

    <!-- Шаг 1: Выбор роли -->
    <div id="step1" class="wizard-container hidden">
        <div class="step-card active">
            <div class="step-number">1</div>
            <div class="step-title">Выберите вашу роль</div>
            <div class="step-description">
                Хотите создать новый звонок или присоединиться к существующему?
            </div>
            <div class="choice-buttons">
                <button class="choice-btn create" id="create-btn">
                    <span class="emoji">📞</span>
                    Создать звонок
                </button>
                <button class="choice-btn join" id="join-btn">
                    <span class="emoji">📲</span>
                    Присоединиться
                </button>
            </div>
        </div>
    </div>

    <!-- Шаг 2a: Создание звонка -->
    <div id="step2-create" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-create">← Назад</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">Создание звонка</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">Ваш ID комнаты</div>
            <div class="step-description">
                Отправьте этот ID собеседнику для подключения
            </div>

            <div class="room-id-display">
                <div>ID комнаты:</div>
                <div class="room-id-value" id="room-id-display"></div>
            </div>

            <button class="button" id="generate-btn">🎲 Сгенерировать новый</button>
            <button class="button primary" id="create-call-btn">Создать звонок</button>
        </div>
    </div>

    <!-- Шаг 2b: Присоединение к звонку -->
    <div id="step2-join" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-join">← Назад</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">Присоединение к звонку</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">Введите ID комнаты</div>
            <div class="step-description">
                Введите ID комнаты, который вам прислал собеседник
            </div>

            <div class="input-group">
                <label for="join-room-id">ID комнаты от собеседника:</label>
                <input type="text" id="join-room-id" placeholder="Например: ABC12345"
                       style="text-align: center; font-size: 20px; letter-spacing: 2px;">
            </div>

            <button class="button primary" id="join-call-btn">Присоединиться</button>
        </div>
    </div>

    <!-- Шаг 3: Автоматическое подключение -->
    <div id="step3" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-step3">← Назад</button>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="step-card active">
            <div class="step-number">3</div>
            <div class="step-title" id="connection-title">Автоматическое подключение</div>
            <div class="step-description" id="connection-description">
                Инициализация соединения...
            </div>

            <div id="status" class="status">Готов к подключению</div>
        </div>
    </div>

    <!-- Видеозвонок -->
    <div id="video-container" class="video-container">
        <div class="video-grid" id="video-grid">
            <div class="video-wrapper local-video-wrapper">
                <video id="local-video" autoplay muted playsinline></video>
                <div class="video-label">Вы</div>
            </div>
            <div class="video-wrapper">
                <video id="remote-video" autoplay playsinline></video>
                <div class="video-label">Собеседник</div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn mic" id="mic-btn" title="Микрофон">🎤</button>
            <button class="control-btn camera" id="camera-btn" title="Камера">📹</button>
            <button class="control-btn share" id="share-btn" title="Поделиться экраном">🖥️</button>
            <button class="control-btn fullscreen" id="fullscreen-btn" title="Скрыть мое видео">👁️</button>
            <button class="control-btn hangup" id="hangup-btn" title="Завершить звонок">📞</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

<script>
    let localStream;
    let cameraStream;
    let remoteStream;
    let peerConnection;
    let isInitiator = false;
    let roomId = '';
    let micEnabled = true;
    let cameraEnabled = true;
    let isFullscreen = false;
    let isScreenSharing = false;
    let currentStep = 1;
    let userRole = '';
    let firebaseApp = null;
    let database = null;
    let auth = null;
    let roomRef = null;
    let currentUser = null;

    const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ];

    // Firebase конфигурация
    async function connectToFirebase() {
        const apiKey = document.getElementById('api-key').value.trim();
        const projectId = document.getElementById('project-id').value.trim();
        const databaseURL = document.getElementById('database-url').value.trim();

        if (!apiKey || !projectId || !databaseURL) {
            alert('Пожалуйста, заполните все поля конфигурации Firebase');
            return;
        }

        try {
            updateStatus('🔄 Подключение к Firebase...');
            
            const firebaseConfig = {
                apiKey: apiKey,
                authDomain: `${projectId}.firebaseapp.com`,
                databaseURL: databaseURL,
                projectId: projectId,
                storageBucket: `${projectId}.appspot.com`,
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abcdef123456"
            };

            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            
            updateStatus('🔑 Аутентификация...');
            
            // Анонимная аутентификация для доступа к приватной БД
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            updateStatus('✅ Firebase подключен успешно!');
            console.log('Аутентифицирован как:', currentUser.uid);
            
            showStep('step1');
            currentStep = 1;
        } catch (error) {
            console.error('Ошибка подключения к Firebase:', error);
            
            let errorMessage = 'Ошибка подключения к Firebase: ';
            
            switch (error.code) {
                case 'auth/api-key-not-valid':
                    errorMessage += 'Неверный API ключ';
                    break;
                case 'auth/invalid-api-key':
                    errorMessage += 'Недействительный API ключ';
                    break;
                case 'auth/project-not-found':
                    errorMessage += 'Проект не найден';
                    break;
                case 'auth/network-request-failed':
                    errorMessage += 'Ошибка сети. Проверьте интернет соединение';
                    break;
                case 'permission-denied':
                    errorMessage += 'Нет доступа к БД. Проверьте правила безопасности';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            alert(errorMessage);
            updateStatus('❌ Ошибка подключения к Firebase');
        }
    }

    // Навигация по шагам
    function showStep(stepId) {
        document.querySelectorAll('.wizard-container, .video-container').forEach(el => {
            el.classList.add('hidden');
        });
        document.getElementById(stepId).classList.remove('hidden');
    }

    function chooseRole(role) {
        userRole = role;
        generateRoomId();

        if (role === 'create') {
            document.getElementById('room-id-display').textContent = roomId;
            showStep('step2-create');
        } else {
            showStep('step2-join');
        }
        currentStep = 2;
    }

    function goBack() {
        if (currentStep === 2) {
            showStep('step1');
            currentStep = 1;
        } else if (currentStep === 3) {
            if (userRole === 'create') {
                showStep('step2-create');
            } else {
                showStep('step2-join');
            }
            currentStep = 2;
            cleanup();
        }
    }

    function generateRoomId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        roomId = result;
        return result;
    }

    function generateNewRoomId() {
        generateRoomId();
        document.getElementById('room-id-display').textContent = roomId;
    }

    async function startCreatingCall() {
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('connection-title').textContent = 'Создание звонка';
        document.getElementById('connection-description').textContent = 'Подключаем камеру и микрофон...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('connection-description').textContent = 'Создаем комнату и ждем собеседника...';

        await createRoom();
        isInitiator = true;

        updateProgress(75);
        document.getElementById('connection-description').textContent = 'Комната создана! Ждем подключения собеседника...';
        updateStatus('🏠 Комната создана. Ждем собеседника...');
    }

    async function startJoiningCall() {
        const enteredRoomId = document.getElementById('join-room-id').value.trim();
        if (!enteredRoomId) {
            alert('Введите ID комнаты');
            return;
        }

        roomId = enteredRoomId;
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('connection-title').textContent = 'Присоединение к звонку';
        document.getElementById('connection-description').textContent = 'Подключаем камеру и микрофон...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('connection-description').textContent = 'Присоединяемся к комнате...';

        await joinRoom();
        isInitiator = false;

        updateProgress(75);
        document.getElementById('connection-description').textContent = 'Присоединились к комнате! Устанавливаем соединение...';
    }

    function updateProgress(percent) {
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    async function initializeMedia() {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30, max: 30 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };

            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            localStream = cameraStream;
            document.getElementById('local-video').srcObject = localStream;
            updateStatus('Камера и микрофон подключены ✓');
            return true;
        } catch (error) {
            updateStatus('Ошибка доступа к камере/микрофону: ' + error.message);
            return false;
        }
    }

    async function createRoom() {
        if (!currentUser) {
            updateStatus('❌ Ошибка: пользователь не аутентифицирован');
            return;
        }

        roomRef = database.ref('rooms').child(roomId);
        
        try {
            // Создаем комнату с информацией о создателе
            await roomRef.set({
                created: firebase.database.ServerValue.TIMESTAMP,
                host: currentUser.uid,
                hostConnected: true
            });

            createPeerConnection();

            // Создаем offer и записываем в Firebase
            const offer = await peerConnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            });
            await peerConnection.setLocalDescription(offer);

            await roomRef.child('offer').set({
                type: offer.type,
                sdp: offer.sdp,
                from: currentUser.uid
            });

            // Слушаем answer от собеседника
            roomRef.child('answer').on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer && answer.from !== currentUser.uid && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    updateStatus('🤝 Соединение с собеседником установлено!');
                }
            });

            // Слушаем ICE кандидатов
            roomRef.child('iceCandidates').on('child_added', async (snapshot) => {
                const candidate = snapshot.val();
                if (candidate && candidate.candidate && candidate.from !== currentUser.uid) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            // Отслеживаем отключение собеседника
            roomRef.child('guestConnected').on('value', (snapshot) => {
                const guestConnected = snapshot.val();
                if (guestConnected === false) {
                    updateStatus('📴 Собеседник отключился');
                }
            });

        } catch (error) {
            console.error('Ошибка создания комнаты:', error);
            updateStatus('❌ Ошибка создания комнаты: ' + error.message);
        }
    }

    async function joinRoom() {
        if (!currentUser) {
            updateStatus('❌ Ошибка: пользователь не аутентифицирован');
            return;
        }

        roomRef = database.ref('rooms').child(roomId);
        
        try {
            // Проверяем существование комнаты
            const roomSnapshot = await roomRef.once('value');
            if (!roomSnapshot.exists()) {
                updateStatus('❌ Комната с ID ' + roomId + ' не найдена!');
                return;
            }

            // Отмечаем подключение гостя
            await roomRef.child('guestConnected').set(true);
            await roomRef.child('guest').set(currentUser.uid);

            createPeerConnection();

            // Получаем offer от хоста
            const offerSnapshot = await roomRef.child('offer').once('value');
            const offer = offerSnapshot.val();
            
            if (offer && offer.from !== currentUser.uid) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // Создаем answer и записываем в Firebase
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                await roomRef.child('answer').set({
                    type: answer.type,
                    sdp: answer.sdp,
                    from: currentUser.uid
                });

                updateStatus('📡 Отправили ответ хосту...');
            }

            // Слушаем ICE кандидатов
            roomRef.child('iceCandidates').on('child_added', async (snapshot) => {
                const candidate = snapshot.val();
                if (candidate && candidate.candidate && candidate.from !== currentUser.uid) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            // Отслеживаем отключение хоста
            roomRef.child('hostConnected').on('value', (snapshot) => {
                const hostConnected = snapshot.val();
                if (hostConnected === false) {
                    updateStatus('📴 Хост отключился');
                }
            });

        } catch (error) {
            console.error('Ошибка подключения к комнате:', error);
            updateStatus('❌ Ошибка подключения к комнате: ' + error.message);
        }
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection({ iceServers });

        if (localStream) {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remote-video');
            if (event.streams && event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
                updateStatus('Видеопоток получен от собеседника ✓');
            }
        };

        peerConnection.onicecandidate = async (event) => {
            if (event.candidate && roomRef && currentUser) {
                // Отправляем ICE кандидата в Firebase с информацией об отправителе
                const candidateData = {
                    ...event.candidate.toJSON(),
                    from: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                await roomRef.child('iceCandidates').push(candidateData);
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            const s = peerConnection.iceConnectionState;
            if (s === 'checking') updateStatus('🔍 Проверка соединения...');
            if (s === 'connected') updateStatus('✅ Соединение установлено!');
            if (s === 'disconnected') updateStatus('⚠️ Соединение временно потеряно...');
            if (s === 'failed') updateStatus('❌ Ошибка соединения. Попробуйте еще раз.');
            if (s === 'closed') updateStatus('Соединение закрыто');
        };

        peerConnection.onconnectionstatechange = () => {
            const state = peerConnection.connectionState;
            if (state === 'connected') {
                showVideoInterface();
                updateStatus('🎉 Соединение установлено успешно!');
            }
        };
    }

    function showVideoInterface() {
        document.getElementById('video-container').style.display = 'block';
        showStep('video-container');
        updateProgress(100);
    }

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
    }

    function toggleMic() {
        const btn = document.getElementById('mic-btn');
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                micEnabled = !micEnabled;
                audioTrack.enabled = micEnabled;
                btn.classList.toggle('off', !micEnabled);
                btn.innerHTML = micEnabled ? '🎤' : '🔇';
            }
        }
    }

    function toggleCamera() {
        const btn = document.getElementById('camera-btn');
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                cameraEnabled = !cameraEnabled;
                videoTrack.enabled = cameraEnabled;
                btn.classList.toggle('off', !cameraEnabled);
                btn.innerHTML = cameraEnabled ? '📹' : '📷';
            }
        }
    }

    async function toggleScreenShare() {
        const btn = document.getElementById('share-btn');

        try {
            if (!isScreenSharing) {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });

                if (peerConnection) {
                    const sender = peerConnection.getSenders().find(s =>
                        s.track && s.track.kind === 'video'
                    );
                    if (sender) {
                        await sender.replaceTrack(screenStream.getVideoTracks()[0]);
                    }
                }

                document.getElementById('local-video').srcObject = screenStream;
                isScreenSharing = true;
                btn.classList.add('active');
                btn.innerHTML = '🎥';

                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopScreenShare();
                });
            } else {
                stopScreenShare();
            }
        } catch (error) {
            console.error('Ошибка демонстрации экрана:', error);
        }
    }

    async function stopScreenShare() {
        const btn = document.getElementById('share-btn');

        if (cameraStream && peerConnection) {
            const sender = peerConnection.getSenders().find(s =>
                s.track && s.track.kind === 'video'
            );
            if (sender) {
                await sender.replaceTrack(cameraStream.getVideoTracks()[0]);
            }
        }

        document.getElementById('local-video').srcObject = cameraStream;
        isScreenSharing = false;
        btn.classList.remove('active');
        btn.innerHTML = '🖥️';
    }

    function toggleFullscreen() {
        const grid = document.getElementById('video-grid');
        const btn = document.getElementById('fullscreen-btn');

        isFullscreen = !isFullscreen;
        grid.classList.toggle('fullscreen', isFullscreen);
        btn.innerHTML = isFullscreen ? '👁️‍🗨️' : '👁️';
    }

    function hangUp() {
        cleanup();
        showStep('step1');
        currentStep = 1;
        userRole = '';
        updateStatus('Звонок завершен');
    }

    function cleanup() {
        // Останавливаем медиа потоки
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }

        // Закрываем peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        // Отмечаем отключение в Firebase
        if (roomRef && currentUser) {
            if (isInitiator) {
                roomRef.child('hostConnected').set(false);
            } else {
                roomRef.child('guestConnected').set(false);
            }
            roomRef.off();
            roomRef = null;
        }

        // Очищаем видео элементы
        document.getElementById('local-video').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        document.getElementById('video-container').style.display = 'none';

        // Сброс состояния
        micEnabled = true;
        cameraEnabled = true;
        isFullscreen = false;
        isScreenSharing = false;

        // Сброс кнопок управления
        document.getElementById('mic-btn').classList.remove('off');
        document.getElementById('mic-btn').innerHTML = '🎤';
        document.getElementById('camera-btn').classList.remove('off');
        document.getElementById('camera-btn').innerHTML = '📹';
        document.getElementById('share-btn').classList.remove('active');
        document.getElementById('share-btn').innerHTML = '🖥️';
        document.getElementById('fullscreen-btn').innerHTML = '👁️';
        document.getElementById('video-grid').classList.remove('fullscreen');

        // Очистка полей ввода
        document.getElementById('join-room-id').value = '';

        updateProgress(0);
    }

    // Инициализация событий
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчики событий для кнопок
        document.getElementById('connect-firebase-btn').addEventListener('click', connectToFirebase);
        
        document.getElementById('create-btn').addEventListener('click', () => chooseRole('create'));
        document.getElementById('join-btn').addEventListener('click', () => chooseRole('join'));

        document.getElementById('back-btn-create').addEventListener('click', goBack);
        document.getElementById('back-btn-join').addEventListener('click', goBack);
        document.getElementById('back-btn-step3').addEventListener('click', goBack);

        document.getElementById('generate-btn').addEventListener('click', generateNewRoomId);
        document.getElementById('create-call-btn').addEventListener('click', startCreatingCall);
        document.getElementById('join-call-btn').addEventListener('click', startJoiningCall);

        // Обработчики для управления видеозвонком
        document.getElementById('mic-btn').addEventListener('click', toggleMic);
        document.getElementById('camera-btn').addEventListener('click', toggleCamera);
        document.getElementById('share-btn').addEventListener('click', toggleScreenShare);
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        document.getElementById('hangup-btn').addEventListener('click', hangUp);
    });
</script>
</body>
</html>