<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ —Å Firebase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .wizard-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .step-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .step-card.active {
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }

        .step-card.completed {
            opacity: 0.7;
            background: rgba(78, 205, 196, 0.2);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 15px;
        }

        .step-card.completed .step-number {
            background: #4ecdc4;
        }

        .step-card.completed .step-number::after {
            content: '‚úì';
            color: white;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .step-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .choice-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            position: relative;
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .choice-btn.create {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .choice-btn.join {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .choice-btn .emoji {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 16px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-group input:focus, .input-group textarea:focus {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .room-id-display {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .room-id-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 180px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #44a08d, #4ecdc4);
        }

        .button:active { transform: translateY(-1px); }

        .button.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .button.primary:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-container {
            display: none;
            width: 100%;
            position: relative;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-grid.fullscreen {
            grid-template-columns: 1fr;
        }

        .video-grid.fullscreen .local-video-wrapper {
            display: none;
        }

        .video-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .local-video-wrapper video {
            transform: scaleX(-1);
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            position: relative;
        }

        .control-btn.mic { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .control-btn.camera { background: linear-gradient(45deg, #667eea, #764ba2); }
        .control-btn.hangup { background: linear-gradient(45deg, #ff6b6b, #ee5a52); }
        .control-btn.fullscreen { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .control-btn.share { background: linear-gradient(45deg, #f39c12, #d35400); }
        .control-btn:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .control-btn.off { opacity: 0.5; background: #666; }

        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.5s ease;
        }

        .config-section {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .config-section h4 {
            margin-bottom: 10px;
            color: #ffc107;
        }

        .config-section p {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .video-grid { grid-template-columns: 1fr; }
            .choice-buttons { flex-direction: column; }
            .choice-btn { min-width: unset; }
            .controls { gap: 10px; }
            .control-btn { width: 50px; height: 50px; font-size: 20px; }
            .wizard-container { max-width: 100%; }
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden { display: none !important; }
        .waiting { opacity: 0.6; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üé• P2P –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ Firebase</p>
    </div>

    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase -->
    <div id="firebase-config" class="wizard-container">
        <div class="step-card active">
            <div class="step-number">‚öôÔ∏è</div>
            <div class="step-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase</div>
            <div class="step-description">
                –í–≤–µ–¥–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ Firebase –ø—Ä–æ–µ–∫—Ç–∞
            </div>
            
            <div class="config-section">
                <h4>üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π Firebase –ë–î:</h4>
                <p><strong>1. Firebase Console:</strong></p>
                <p>‚Ä¢ –ó–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–æ–µ–∫—Ç ‚Üí <strong>Realtime Database</strong></p>
                <p>‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –≤ <strong>locked mode</strong></p>
                <p>‚Ä¢ –í —Ä–∞–∑–¥–µ–ª–µ <strong>Rules</strong> —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:</p>
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0;">
{<br>
&nbsp;&nbsp;"rules": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;"rooms": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"$roomId": {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".read": "auth != null",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".write": "auth != null"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
                </div>
                <p><strong>2. Authentication:</strong></p>
                <p>‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <strong>Authentication</strong> ‚Üí <strong>Sign-in method</strong></p>
                <p>‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ <strong>Anonymous</strong> –ø—Ä–æ–≤–∞–π–¥–µ—Ä</p>
            </div>

            <div class="input-group">
                <label for="api-key">API Key:</label>
                <input type="text" id="api-key" placeholder="AIzaSyA...">
            </div>

            <div class="input-group">
                <label for="project-id">Project ID:</label>
                <input type="text" id="project-id" placeholder="my-project-12345">
            </div>

            <div class="input-group">
                <label for="database-url">Database URL:</label>
                <input type="text" id="database-url" placeholder="https://my-project-12345-default-rtdb.firebaseio.com/">
            </div>

            <button class="button primary" id="connect-firebase-btn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase</button>
        </div>
    </div>

    <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
    <div id="step1" class="wizard-container hidden">
        <div class="step-card active">
            <div class="step-number">1</div>
            <div class="step-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å</div>
            <div class="step-description">
                –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É?
            </div>
            <div class="choice-buttons">
                <button class="choice-btn create" id="create-btn">
                    <span class="emoji">üìû</span>
                    –°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="choice-btn join" id="join-btn">
                    <span class="emoji">üì≤</span>
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>

    <!-- –®–∞–≥ 2a: –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ -->
    <div id="step2-create" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-create">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">–°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">–í–∞—à ID –∫–æ–º–Ω–∞—Ç—ã</div>
            <div class="step-description">
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </div>

            <div class="room-id-display">
                <div>ID –∫–æ–º–Ω–∞—Ç—ã:</div>
                <div class="room-id-value" id="room-id-display"></div>
            </div>

            <button class="button" id="generate-btn">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="button primary" id="create-call-btn">–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>
    </div>

    <!-- –®–∞–≥ 2b: –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É -->
    <div id="step2-join" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-join">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="step-card completed">
            <div class="step-number"></div>
            <div class="step-title">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É</div>
        </div>

        <div class="step-card active">
            <div class="step-number">2</div>
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã</div>
            <div class="step-description">
                –í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –ø—Ä–∏—Å–ª–∞–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫
            </div>

            <div class="input-group">
                <label for="join-room-id">ID –∫–æ–º–Ω–∞—Ç—ã –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
                <input type="text" id="join-room-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ABC12345"
                       style="text-align: center; font-size: 20px; letter-spacing: 2px;">
            </div>

            <button class="button primary" id="join-call-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –®–∞–≥ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
    <div id="step3" class="wizard-container hidden">
        <button class="back-btn" id="back-btn-step3">‚Üê –ù–∞–∑–∞–¥</button>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="step-card active">
            <div class="step-number">3</div>
            <div class="step-title" id="connection-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
            <div class="step-description" id="connection-description">
                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...
            </div>

            <div id="status" class="status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ -->
    <div id="video-container" class="video-container">
        <div class="video-grid" id="video-grid">
            <div class="video-wrapper local-video-wrapper">
                <video id="local-video" autoplay muted playsinline></video>
                <div class="video-label">–í—ã</div>
            </div>
            <div class="video-wrapper">
                <video id="remote-video" autoplay playsinline></video>
                <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn mic" id="mic-btn" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button class="control-btn camera" id="camera-btn" title="–ö–∞–º–µ—Ä–∞">üìπ</button>
            <button class="control-btn share" id="share-btn" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º">üñ•Ô∏è</button>
            <button class="control-btn fullscreen" id="fullscreen-btn" title="–°–∫—Ä—ã—Ç—å –º–æ–µ –≤–∏–¥–µ–æ">üëÅÔ∏è</button>
            <button class="control-btn hangup" id="hangup-btn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

<script>
    let localStream;
    let cameraStream;
    let remoteStream;
    let peerConnection;
    let isInitiator = false;
    let roomId = '';
    let micEnabled = true;
    let cameraEnabled = true;
    let isFullscreen = false;
    let isScreenSharing = false;
    let currentStep = 1;
    let userRole = '';
    let firebaseApp = null;
    let database = null;
    let auth = null;
    let roomRef = null;
    let currentUser = null;

    const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ];

    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    async function connectToFirebase() {
        const apiKey = document.getElementById('api-key').value.trim();
        const projectId = document.getElementById('project-id').value.trim();
        const databaseURL = document.getElementById('database-url').value.trim();

        if (!apiKey || !projectId || !databaseURL) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase');
            return;
        }

        try {
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...');
            
            const firebaseConfig = {
                apiKey: apiKey,
                authDomain: `${projectId}.firebaseapp.com`,
                databaseURL: databaseURL,
                projectId: projectId,
                storageBucket: `${projectId}.appspot.com`,
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abcdef123456"
            };

            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            
            updateStatus('üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...');
            
            // –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –ë–î
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            updateStatus('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            console.log('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∫–∞–∫:', currentUser.uid);
            
            showStep('step1');
            currentStep = 1;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase:', error);
            
            let errorMessage = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase: ';
            
            switch (error.code) {
                case 'auth/api-key-not-valid':
                    errorMessage += '–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á';
                    break;
                case 'auth/invalid-api-key':
                    errorMessage += '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π API –∫–ª—é—á';
                    break;
                case 'auth/project-not-found':
                    errorMessage += '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    break;
                case 'auth/network-request-failed':
                    errorMessage += '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
                    break;
                case 'permission-denied':
                    errorMessage += '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            alert(errorMessage);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase');
        }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∞–≥–∞–º
    function showStep(stepId) {
        document.querySelectorAll('.wizard-container, .video-container').forEach(el => {
            el.classList.add('hidden');
        });
        document.getElementById(stepId).classList.remove('hidden');
    }

    function chooseRole(role) {
        userRole = role;
        generateRoomId();

        if (role === 'create') {
            document.getElementById('room-id-display').textContent = roomId;
            showStep('step2-create');
        } else {
            showStep('step2-join');
        }
        currentStep = 2;
    }

    function goBack() {
        if (currentStep === 2) {
            showStep('step1');
            currentStep = 1;
        } else if (currentStep === 3) {
            if (userRole === 'create') {
                showStep('step2-create');
            } else {
                showStep('step2-join');
            }
            currentStep = 2;
            cleanup();
        }
    }

    function generateRoomId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        roomId = result;
        return result;
    }

    function generateNewRoomId() {
        generateRoomId();
        document.getElementById('room-id-display').textContent = roomId;
    }

    async function startCreatingCall() {
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('connection-title').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞';
        document.getElementById('connection-description').textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('connection-description').textContent = '–°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –∏ –∂–¥–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';

        await createRoom();
        isInitiator = true;

        updateProgress(75);
        document.getElementById('connection-description').textContent = '–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';
        updateStatus('üè† –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞. –ñ–¥–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
    }

    async function startJoiningCall() {
        const enteredRoomId = document.getElementById('join-room-id').value.trim();
        if (!enteredRoomId) {
            alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            return;
        }

        roomId = enteredRoomId;
        showStep('step3');
        currentStep = 3;
        updateProgress(25);

        document.getElementById('connection-title').textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É';
        document.getElementById('connection-description').textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω...';

        if (!await initializeMedia()) return;

        updateProgress(50);
        document.getElementById('connection-description').textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ...';

        await joinRoom();
        isInitiator = false;

        updateProgress(75);
        document.getElementById('connection-description').textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ! –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
    }

    function updateProgress(percent) {
        document.getElementById('progress-fill').style.width = percent + '%';
    }

    async function initializeMedia() {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30, max: 30 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };

            cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            localStream = cameraStream;
            document.getElementById('local-video').srcObject = localStream;
            updateStatus('–ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω—ã ‚úì');
            return true;
        } catch (error) {
            updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
            return false;
        }
    }

    async function createRoom() {
        if (!currentUser) {
            updateStatus('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            return;
        }

        roomRef = database.ref('rooms').child(roomId);
        
        try {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ
            await roomRef.set({
                created: firebase.database.ServerValue.TIMESTAMP,
                host: currentUser.uid,
                hostConnected: true
            });

            createPeerConnection();

            // –°–æ–∑–¥–∞–µ–º offer –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firebase
            const offer = await peerConnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            });
            await peerConnection.setLocalDescription(offer);

            await roomRef.child('offer').set({
                type: offer.type,
                sdp: offer.sdp,
                from: currentUser.uid
            });

            // –°–ª—É—à–∞–µ–º answer –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            roomRef.child('answer').on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer && answer.from !== currentUser.uid && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    updateStatus('ü§ù –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                }
            });

            // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            roomRef.child('iceCandidates').on('child_added', async (snapshot) => {
                const candidate = snapshot.val();
                if (candidate && candidate.candidate && candidate.from !== currentUser.uid) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            roomRef.child('guestConnected').on('value', (snapshot) => {
                const guestConnected = snapshot.val();
                if (guestConnected === false) {
                    updateStatus('üì¥ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                }
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
        }
    }

    async function joinRoom() {
        if (!currentUser) {
            updateStatus('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            return;
        }

        roomRef = database.ref('rooms').child(roomId);
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            const roomSnapshot = await roomRef.once('value');
            if (!roomSnapshot.exists()) {
                updateStatus('‚ùå –ö–æ–º–Ω–∞—Ç–∞ —Å ID ' + roomId + ' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                return;
            }

            // –û—Ç–º–µ—á–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≥–æ—Å—Ç—è
            await roomRef.child('guestConnected').set(true);
            await roomRef.child('guest').set(currentUser.uid);

            createPeerConnection();

            // –ü–æ–ª—É—á–∞–µ–º offer –æ—Ç —Ö–æ—Å—Ç–∞
            const offerSnapshot = await roomRef.child('offer').once('value');
            const offer = offerSnapshot.val();
            
            if (offer && offer.from !== currentUser.uid) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // –°–æ–∑–¥–∞–µ–º answer –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firebase
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                await roomRef.child('answer').set({
                    type: answer.type,
                    sdp: answer.sdp,
                    from: currentUser.uid
                });

                updateStatus('üì° –û—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–≤–µ—Ç —Ö–æ—Å—Ç—É...');
            }

            // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            roomRef.child('iceCandidates').on('child_added', async (snapshot) => {
                const candidate = snapshot.val();
                if (candidate && candidate.candidate && candidate.from !== currentUser.uid) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ö–æ—Å—Ç–∞
            roomRef.child('hostConnected').on('value', (snapshot) => {
                const hostConnected = snapshot.val();
                if (hostConnected === false) {
                    updateStatus('üì¥ –•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
                }
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ: ' + error.message);
        }
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection({ iceServers });

        if (localStream) {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remote-video');
            if (event.streams && event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
                updateStatus('–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ‚úì');
            }
        };

        peerConnection.onicecandidate = async (event) => {
            if (event.candidate && roomRef && currentUser) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ Firebase —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
                const candidateData = {
                    ...event.candidate.toJSON(),
                    from: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                await roomRef.child('iceCandidates').push(candidateData);
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            const s = peerConnection.iceConnectionState;
            if (s === 'checking') updateStatus('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
            if (s === 'connected') updateStatus('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            if (s === 'disconnected') updateStatus('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Ç–µ—Ä—è–Ω–æ...');
            if (s === 'failed') updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            if (s === 'closed') updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
        };

        peerConnection.onconnectionstatechange = () => {
            const state = peerConnection.connectionState;
            if (state === 'connected') {
                showVideoInterface();
                updateStatus('üéâ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
            }
        };
    }

    function showVideoInterface() {
        document.getElementById('video-container').style.display = 'block';
        showStep('video-container');
        updateProgress(100);
    }

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
    }

    function toggleMic() {
        const btn = document.getElementById('mic-btn');
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                micEnabled = !micEnabled;
                audioTrack.enabled = micEnabled;
                btn.classList.toggle('off', !micEnabled);
                btn.innerHTML = micEnabled ? 'üé§' : 'üîá';
            }
        }
    }

    function toggleCamera() {
        const btn = document.getElementById('camera-btn');
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                cameraEnabled = !cameraEnabled;
                videoTrack.enabled = cameraEnabled;
                btn.classList.toggle('off', !cameraEnabled);
                btn.innerHTML = cameraEnabled ? 'üìπ' : 'üì∑';
            }
        }
    }

    async function toggleScreenShare() {
        const btn = document.getElementById('share-btn');

        try {
            if (!isScreenSharing) {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });

                if (peerConnection) {
                    const sender = peerConnection.getSenders().find(s =>
                        s.track && s.track.kind === 'video'
                    );
                    if (sender) {
                        await sender.replaceTrack(screenStream.getVideoTracks()[0]);
                    }
                }

                document.getElementById('local-video').srcObject = screenStream;
                isScreenSharing = true;
                btn.classList.add('active');
                btn.innerHTML = 'üé•';

                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopScreenShare();
                });
            } else {
                stopScreenShare();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:', error);
        }
    }

    async function stopScreenShare() {
        const btn = document.getElementById('share-btn');

        if (cameraStream && peerConnection) {
            const sender = peerConnection.getSenders().find(s =>
                s.track && s.track.kind === 'video'
            );
            if (sender) {
                await sender.replaceTrack(cameraStream.getVideoTracks()[0]);
            }
        }

        document.getElementById('local-video').srcObject = cameraStream;
        isScreenSharing = false;
        btn.classList.remove('active');
        btn.innerHTML = 'üñ•Ô∏è';
    }

    function toggleFullscreen() {
        const grid = document.getElementById('video-grid');
        const btn = document.getElementById('fullscreen-btn');

        isFullscreen = !isFullscreen;
        grid.classList.toggle('fullscreen', isFullscreen);
        btn.innerHTML = isFullscreen ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
    }

    function hangUp() {
        cleanup();
        showStep('step1');
        currentStep = 1;
        userRole = '';
        updateStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
    }

    function cleanup() {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }

        // –û—Ç–º–µ—á–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤ Firebase
        if (roomRef && currentUser) {
            if (isInitiator) {
                roomRef.child('hostConnected').set(false);
            } else {
                roomRef.child('guestConnected').set(false);
            }
            roomRef.off();
            roomRef = null;
        }

        // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
        document.getElementById('local-video').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        document.getElementById('video-container').style.display = 'none';

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        micEnabled = true;
        cameraEnabled = true;
        isFullscreen = false;
        isScreenSharing = false;

        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('mic-btn').classList.remove('off');
        document.getElementById('mic-btn').innerHTML = 'üé§';
        document.getElementById('camera-btn').classList.remove('off');
        document.getElementById('camera-btn').innerHTML = 'üìπ';
        document.getElementById('share-btn').classList.remove('active');
        document.getElementById('share-btn').innerHTML = 'üñ•Ô∏è';
        document.getElementById('fullscreen-btn').innerHTML = 'üëÅÔ∏è';
        document.getElementById('video-grid').classList.remove('fullscreen');

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        document.getElementById('join-room-id').value = '';

        updateProgress(0);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.getElementById('connect-firebase-btn').addEventListener('click', connectToFirebase);
        
        document.getElementById('create-btn').addEventListener('click', () => chooseRole('create'));
        document.getElementById('join-btn').addEventListener('click', () => chooseRole('join'));

        document.getElementById('back-btn-create').addEventListener('click', goBack);
        document.getElementById('back-btn-join').addEventListener('click', goBack);
        document.getElementById('back-btn-step3').addEventListener('click', goBack);

        document.getElementById('generate-btn').addEventListener('click', generateNewRoomId);
        document.getElementById('create-call-btn').addEventListener('click', startCreatingCall);
        document.getElementById('join-call-btn').addEventListener('click', startJoiningCall);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–º
        document.getElementById('mic-btn').addEventListener('click', toggleMic);
        document.getElementById('camera-btn').addEventListener('click', toggleCamera);
        document.getElementById('share-btn').addEventListener('click', toggleScreenShare);
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        document.getElementById('hangup-btn').addEventListener('click', hangUp);
    });
</script>
</body>
</html>